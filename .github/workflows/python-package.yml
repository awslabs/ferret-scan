name: Build Python Package

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_call:
    outputs:
      package-path:
        description: "Path to built Python package"
        value: ${{ jobs.test-and-release.outputs.package-path }}

permissions:
  contents: write # Needed for creating releases

jobs:
  build:
    uses: ./.github/workflows/build-shared.yml
    with:
      build-type: "python"
    permissions:
      contents: read

  test-and-release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write # Needed for creating releases
    outputs:
      package-path: python-package/dist/

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Download Python package
        uses: actions/download-artifact@v4
        with:
          name: ferret-scan-python-${{ github.sha }}
          path: python-package/dist/

      - name: Test installation and functionality
        run: |
          cd python-package
          pip install dist/*.whl

          # Test version
          ferret-scan --version

          # Test basic functionality
          echo "Test credit card: 4111-1111-1111-1111" > test.txt
          ferret-scan --file test.txt --confidence high || true
          rm test.txt

          # Test help
          ferret-scan --help | head -5

          echo "‚úÖ Python package installation and basic functionality tests passed"

      - name: Upload Python package artifacts (final)
        uses: actions/upload-artifact@v4
        with:
          name: python-package-release
          path: python-package/dist/
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: python-package/dist/*
          generate_release_notes: true
          body: |
            ## üêç Python Package Installation

            ```bash
            pip install ferret-scan
            ```

            ### Quick Start:
            ```bash
            ferret-scan --version
            ferret-scan --help
            ```

            **Requirements**: Python 3.7 or higher
            
            ---
            
            **Note**: The PyPI package will be available shortly after this release is published.

  # Call PyPI publishing workflow - trusted publisher should be configured for pypi-publish.yml
  publish-to-pypi:
    if: startsWith(github.ref, 'refs/tags/')
    needs: test-and-release
    uses: ./.github/workflows/pypi-publish.yml
    with:
      version: ${{ github.ref_name }}
    secrets: inherit
    permissions:
      contents: read
      id-token: write # Required for trusted publishing to PyPI
