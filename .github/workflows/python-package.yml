name: Build Python Package

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_call:
    outputs:
      package-path:
        description: "Path to built Python package"
        value: ${{ jobs.test-and-release.outputs.package-path }}

permissions:
  contents: write # Needed for creating releases

jobs:
  build:
    uses: ./.github/workflows/build-shared.yml
    with:
      build-type: "python"
    permissions:
      contents: read

  test-and-release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write # Needed for creating releases
      id-token: write # Required for trusted publishing to PyPI
    environment: 
      name: ${{ startsWith(github.ref, 'refs/tags/') && 'pypi' || '' }}
      url: ${{ startsWith(github.ref, 'refs/tags/') && 'https://pypi.org/p/ferret-scan' || '' }}
    outputs:
      package-path: python-package/dist/

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Download Python package
        uses: actions/download-artifact@v4
        with:
          name: ferret-scan-python-${{ github.sha }}
          path: python-package/dist/

      - name: Test installation and functionality
        run: |
          cd python-package
          pip install dist/*.whl

          # Test version
          ferret-scan --version

          # Test basic functionality
          echo "Test credit card: 4111-1111-1111-1111" > test.txt
          ferret-scan --file test.txt --confidence high || true
          rm test.txt

          # Test help
          ferret-scan --help | head -5

          echo "âœ… Python package installation and basic functionality tests passed"

      - name: Upload Python package artifacts (final)
        uses: actions/upload-artifact@v4
        with:
          name: python-package-release
          path: python-package/dist/
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: python-package/dist/*
          generate_release_notes: true
          body: |
            ## ðŸ Python Package Installation

            ```bash
            pip install ferret-scan
            ```

            ### Quick Start:
            ```bash
            ferret-scan --version
            ferret-scan --help
            ```

            **Requirements**: Python 3.7 or higher
            
            ---
            
            **Note**: The PyPI package will be available shortly after this release is published.

      - name: Publish to PyPI
        if: startsWith(github.ref, 'refs/tags/')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: python-package/dist/
          verbose: true

      - name: Summary
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "## ðŸš€ Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… GitHub release created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Published to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'pip install ferret-scan' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
